<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#2b6df2">
<title>Golf Practice Game — PWA</title>
<style>
  :root { --gap: 14px; --radius: 12px; --ink:#0f0f12; --muted:#666; --line:#e9e9ee; --bg:#f6f7fb; --brand:#2b6df2; }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; }
  body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
         color: var(--ink); background: linear-gradient(180deg,#ffffff 0%, #f6f7fb 100%); padding-bottom: 88px; }
  header { padding: 16px; background: #0f0f12; color: #fff; position: sticky; top: 0; z-index: 10; }
  header h1 { margin: 0; font-size: 18px; letter-spacing: .2px; }
  header .sub { opacity: .8; font-size: 12px; }
  main { display: grid; grid-template-columns: 1fr; gap: var(--gap); padding: var(--gap); max-width: 1100px; margin: 0 auto; }
  @media (min-width: 980px){ main { grid-template-columns: 320px 1fr; } }
  .panel { background:#fff; border-radius: var(--radius); box-shadow: 0 6px 24px rgba(15,17,24,.06), 0 1px 2px rgba(15,17,24,.06); }
  .panel .inner { padding: 14px; }
  h2 { font-size: 16px; margin: 0 0 8px 0; }
  label { display: block; margin: 10px 0 6px; font-weight: 600; font-size: 13px; }
  select, input[type="number"], input[type="text"] {
    width: 100%; padding: 12px 14px; border: 1px solid var(--line); border-radius: 10px; font-size: 16px; background: #fff;
  }
  .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  .btn { padding: 14px 16px; border: 0; border-radius: 12px; cursor: pointer; font-weight: 800; font-size: 16px; }
  .btn.primary { background: var(--brand); color: #fff; }
  .btn.ghost { background: #eef3ff; color: #173e96; }
  .btn.flat { background: #f0f1f5; }
  .btn:disabled { opacity: .5; }
  .buttons-stack .btn { flex: 1 1 auto; min-width: 44%; }
  @media (max-width: 480px){ .buttons-stack .btn { width: 100%; } }
  .pill { padding: 6px 10px; border-radius: 999px; background: #f0f2f7; color:#394258; font-size: 12px; }
  .hint { color: var(--muted); font-size: 13px; }
  .section-title { margin: 4px 0 8px; font-weight: 800; text-transform: uppercase; letter-spacing: .6px; font-size: 12px; color:#3f4658; }
  .task { border: 1px dashed var(--line); padding: 12px; border-radius: 10px; margin: 8px 0; }
  .task strong { font-weight: 800; }
  .timerBox { display: grid; gap: 8px; }
  .timer { font-variant-numeric: tabular-nums; font-weight: 900; font-size: 40px; }
  .bar { height: 12px; background: #edf0f7; border-radius: 999px; overflow: hidden; }
  .bar > span { display: block; height: 100%; width: 0%; background: linear-gradient(90deg,#2b6df2,#67b2f9); transition: width .25s ease; }
  .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: var(--gap); }
  table { width: 100%; border-collapse: collapse; margin-top: 8px; }
  th, td { text-align: left; padding: 12px 8px; border-bottom: 1px solid var(--line); font-size: 14px; }
  .right { text-align: right; }
  details { border:1px solid var(--line); padding: 10px 12px; border-radius: 10px; }
  details summary { cursor: pointer; font-weight: 700; }
  footer { text-align: center; color: #7c8599; padding: 24px; }
  /* Sticky Action Bar */
  .actionbar { position: fixed; left: 0; right: 0; bottom: 0; z-index: 20; background: rgba(255,255,255,0.98);
    border-top: 1px solid var(--line); padding: 10px 12px; backdrop-filter: saturate(140%) blur(8px); }
  .actionbar .row { justify-content: space-between; }
  .actionbar .btn { flex: 1 1 auto; margin: 0 6px; }
</style>
</head>
<body>
<header>
  <h1>Golf Practice Game — PWA</h1>
  <div class="sub">Add to Home Screen in Safari • Offline-ready</div>
</header>

<main>
  <aside class="panel">
    <div class="inner">
      <h2>Session Setup</h2>
      <label>Total duration (minutes)</label>
      <select id="totalMinutes">
        <option>30</option><option selected>45</option><option>60</option>
      </select>
      <label>Focus</label>
      <select id="focus">
        <option value="balanced" selected>Balanced</option>
        <option value="consistency">Consistency</option>
        <option value="accuracy">Accuracy</option>
        <option value="shortgame">Short Game</option>
        <option value="putting">Putting</option>
      </select>
      <label>Your name (optional)</label>
      <input id="playerName" type="text" placeholder="e.g., David">

      <div class="row buttons-stack" style="margin-top:12px;">
        <button class="btn primary" id="generateBtn" type="button" onclick="generate()">Generate Drills</button>
        <button class="btn flat" id="clearBtn" type="button" onclick="clearHistory()">Clear History</button>
      </div>
      <div class="row" style="margin-top:8px; align-items:center;">
        <span class="pill" id="sessionIdPill"></span>
        <span class="hint">Tap Start below to begin; first tap enables sound.</span>
      </div>

      <hr style="margin:16px 0; border:none; border-top:1px solid var(--line)">

      <h2>Quick Challenge</h2>
      <div class="row buttons-stack">
        <button class="btn ghost" id="dealCardBtn" type="button" onclick="dealCard()">Deal Constraint</button>
        <span id="cardText" class="pill"></span>
      </div>
    </div>
  </aside>

  <section class="panel" id="workPanel">
    <div class="inner">
      <div class="section-title">Drills</div>
      <div id="drillsList" class="grid"></div>

      <div class="section-title">Timer</div>
      <div class="timerBox">
        <div class="timer" id="timer">00:00</div>
        <div class="bar"><span id="segBar"></span></div>
        <div class="bar"><span id="overallBar"></span></div>
        <div class="hint" id="nowPlaying">Tap Start below to begin.</div>
      </div>

      <div class="section-title">Scoring</div>
      <div id="scoresTableWrap"></div>

      <div class="row buttons-stack" style="margin-top:10px;">
        <button class="btn primary" id="saveResultsBtn" type="button" onclick="saveResultsClick()">Save Results</button>
        <button class="btn flat" id="exportCsvBtn" type="button" onclick="exportCsv()">Export CSV</button>
        <span id="saveStatus" class="pill"></span>
      </div>

      <div class="section-title">History</div>
      <table id="historyTable">
        <thead><tr><th>Date</th><th>Session</th><th>Focus</th><th>Total Points</th><th>Details</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<!-- Sticky Action Bar -->
<div class="actionbar">
  <div class="row">
    <button class="btn flat" type="button" onclick="togglePause()">Pause</button>
    <button class="btn primary" type="button" onclick="startClick()">Start</button>
    <button class="btn flat" type="button" onclick="skipSeg()">Skip</button>
  </div>
</div>

<footer>v3.0 — PWA package</footer>

<script>
// Register service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}

// ---- Data ----
const CHALLENGE_DECK = [
  "Odd clubs only this segment",
  "Low flight only (keep it under the wind)",
  "Pre-shot: 2 rehearsal swings, eyes closed contact feel",
  "Call the shape (fade/draw) before each shot",
  "One-ball only — no rakes",
  "Putt looking at the spot (not the ball)",
  "Land it short of the hole and roll it out",
  "Add +10% or -10% yardage to simulate wind",
  "No flags — pick intermediate targets"
];

const ALL_DRILLS = [
  // Range
  {cat:"Range", name:"Warm-Up Ladder", mins:5, focus:"consistency", desc:"Wedge → 8i → 5i → Driver, 70% tempo. Routine every swing."},
  {cat:"Range", name:"9-Ball Matrix", mins:6, focus:"accuracy", desc:"Straight/Draw/Fade windows. Note start lines."},
  {cat:"Range", name:"Fairway Finder", mins:5, focus:"accuracy", desc:"Pick narrow window. Score hits."},
  {cat:"Range", name:"Tempo 3-2-1", mins:5, focus:"consistency", desc:"Count 3-2-1 back/through for smooth tempo."},
  {cat:"Range", name:"Wedge Matrix 50/75/100", mins:6, focus:"accuracy", desc:"Control flights to 50/75/100. Track proximity."},
  // Short Game
  {cat:"Short Game", name:"Landing Towel", mins:5, focus:"accuracy", desc:"10/20/30 yd towels. Score land-ons."},
  {cat:"Short Game", name:"One-Ball Scramble", mins:5, focus:"consistency", desc:"Random lies. Play one ball; commit like on-course."},
  {cat:"Short Game", name:"Bunker Up/Down", mins:5, focus:"accuracy", desc:"Splash to 6 ft circle; putt out."},
  {cat:"Short Game", name:"Par-18 (3 holes)", mins:6, focus:"consistency", desc:"Chip/pitch + putt out ×3 spots. Par=6."},
  // Putting
  {cat:"Putting", name:"Gate Start-Line", mins:5, focus:"consistency", desc:"3 ft gate. Crisp strike & start line."},
  {cat:"Putting", name:"Pace Ladder", mins:5, focus:"accuracy", desc:"10/20/30 ft. Stop within 2 ft."},
  {cat:"Putting", name:"Pressure Circle", mins:5, focus:"accuracy", desc:"Six 3-footers around hole. Build streaks."},
  {cat:"Putting", name:"Left/Right Hand Only", mins:4, focus:"consistency", desc:"5 putts each hand to groove face control."}
];

// ---- State ----
let lastBuckets = null;
let currentSessionId = "";
let audioCtx = null;

// ---- Helpers ----
function newSessionId(){ return "S" + Math.random().toString(36).slice(2,8).toUpperCase(); }
function flattenSegments(buckets){
  const segs = [];
  Object.keys(buckets).forEach(cat => buckets[cat].forEach(d => segs.push({cat:cat, name:d.name, secs:d.mins*60})));
  return segs;
}
function fmt(s){ s=Math.max(0, s); const m=Math.floor(s/60), ss=s%60; return String(m).padStart(2,"0")+":"+String(ss).padStart(2,"0"); }

// ---- Render ----
function renderDrills(buckets){
  const list = document.getElementById("drillsList");
  list.innerHTML = "";
  Object.keys(buckets).forEach(cat => {
    const col = document.createElement("div");
    col.className = "panel inner";
    col.style.padding="12px";
    col.innerHTML = `<div class="section-title">${cat}</div>`;
    buckets[cat].forEach(d => {
      const div = document.createElement("div");
      div.className = "task";
      div.innerHTML = `<strong>${d.name}</strong> <span class="hint">• ${d.mins} min</span><br><span class="hint">${d.desc}</span>`;
      col.appendChild(div);
    });
    list.appendChild(col);
  });
}
function renderScoring(buckets, sessionId) {
  const wrap = document.getElementById("scoresTableWrap");
  let rows = "";
  let idx = 0;
  Object.keys(buckets).forEach(cat => {
    buckets[cat].forEach(d => {
      const id = `r${idx++}`;
      rows += `<tr>
        <td>${cat}</td>
        <td>${d.name}</td>
        <td class="right">${d.mins}</td>
        <td><input type="number" min="0" id="${id}_attempts" placeholder="Attempts"></td>
        <td><input type="number" min="0" id="${id}_success" placeholder="Success"></td>
        <td class="right" id="${id}_points">0</td>
      </tr>`;
    });
  });
  const table = `<table>
    <thead>
      <tr><th>Category</th><th>Drill</th><th class="right">Min</th><th>Attempts</th><th>Success</th><th class="right">Points</th></tr>
    </thead>
    <tbody>${rows}</tbody>
    <tfoot>
      <tr><th colspan="5" class="right">Total Points</th><th class="right" id="totalPts">0</th></tr>
    </tfoot>
  </table>`;
  wrap.innerHTML = table;

  wrap.oninput = function(){
    let total = 0;
    for (let i=0;i<idx;i++){
      const a = Number(document.getElementById(`r${i}_attempts`).value||0);
      const s = Number(document.getElementById(`r${i}_success`).value||0);
      let pts = s*2 + (a>0 ? (s/a)*10 : 0);
      pts = Math.round(pts);
      document.getElementById(`r${i}_points`).textContent = pts;
      total += pts;
    }
    document.getElementById("totalPts").textContent = total;
  };
}

// ---- Timer ----
let timerState = { segments: [], idx: 0, segRemaining: 0, running: false, handle: null, totalSecs: 0, elapsed: 0 };
function updateTimerUI(){
  document.getElementById("timer").textContent = fmt(timerState.segRemaining);
  const seg = timerState.segments[timerState.idx];
  const segDur = seg ? seg.secs : 1;
  const segPct = 100 * (1 - timerState.segRemaining/segDur);
  document.getElementById("segBar").style.width = segPct + "%";
  const overallPct = 100 * (timerState.elapsed / Math.max(1,timerState.totalSecs));
  document.getElementById("overallBar").style.width = overallPct + "%";
  document.getElementById("nowPlaying").textContent = seg ? (seg.cat + " — " + seg.name) : "Session ready. Tap Start.";
}
function safeBeep(){
  try{
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    audioCtx.resume && audioCtx.resume();
    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
    o.type = "sine"; o.frequency.value = 880;
    o.connect(g); g.connect(audioCtx.destination);
    g.gain.setValueAtTime(0.001, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.18, audioCtx.currentTime + 0.01);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.25);
    o.start(); o.stop(audioCtx.currentTime + 0.27);
  } catch(e){}
}
function startTimerFlow(){
  if (!timerState.segments.length) return;
  timerState.running = true;
  clearInterval(timerState.handle);
  timerState.handle = setInterval(()=>{
    timerState.segRemaining--;
    timerState.elapsed++;
    updateTimerUI();
    if (timerState.segRemaining <= 0){
      safeBeep();
      timerState.idx++;
      if (timerState.idx >= timerState.segments.length){
        clearInterval(timerState.handle);
        timerState.running = false;
        document.getElementById("nowPlaying").textContent = "Session complete 🎉";
        return;
      }
      timerState.segRemaining = timerState.segments[timerState.idx].secs;
      updateTimerUI();
    }
  }, 1000);
}
function initTimer(buckets){
  timerState.segments = flattenSegments(buckets);
  timerState.idx = 0;
  timerState.totalSecs = timerState.segments.reduce((a,b)=>a+b.secs,0);
  timerState.elapsed = 0;
  timerState.segRemaining = timerState.segments[0] ? timerState.segments[0].secs : 0;
  updateTimerUI();
}

// ---- Actions (inline handlers) ----
function generate(){
  const total = Number(document.getElementById("totalMinutes").value);
  const focus = document.getElementById("focus").value;
  currentSessionId = newSessionId();
  document.getElementById("sessionIdPill").textContent = "Session " + currentSessionId;
  const buckets = pickDrills(total, focus);
  lastBuckets = buckets;
  renderDrills(buckets);
  renderScoring(buckets, currentSessionId);
  initTimer(buckets);
  refreshHistory();
}
function startClick(){
  if (!lastBuckets) generate();
  try{ if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); audioCtx.resume && audioCtx.resume(); }catch(e){}
  startTimerFlow();
}
function togglePause(){
  if (!timerState.segments.length) return;
  if (timerState.running){ clearInterval(timerState.handle); timerState.running = false; }
  else { startTimerFlow(); }
}
function skipSeg(){
  if (!timerState.segments.length) return;
  timerState.idx++;
  if (timerState.idx >= timerState.segments.length){
    clearInterval(timerState.handle);
    timerState.running = false;
    document.getElementById("nowPlaying").textContent = "Session complete 🎉";
    updateTimerUI();
    return;
  }
  timerState.segRemaining = timerState.segments[timerState.idx].secs;
  updateTimerUI();
  if (!timerState.running) startTimerFlow();
}
function saveResultsClick(){
  const focus = document.getElementById("focus").value;
  if (!currentSessionId) currentSessionId = newSessionId();
  saveResults(currentSessionId, focus);
  document.getElementById("saveStatus").textContent = "Saved ✔";
  setTimeout(function(){ document.getElementById("saveStatus").textContent=""; }, 2000);
  refreshHistory();
}

// ---- Persistence & Export ----
function saveResults(sessionId, focus) {
  const table = document.querySelector("#scoresTableWrap table tbody");
  if (!table) return;
  const rows = Array.from(table.querySelectorAll("tr"));
  let details = [];
  let total = 0;
  rows.forEach((tr)=>{
    const tds = tr.querySelectorAll("td");
    const cat = tds[0].textContent;
    const name = tds[1].textContent;
    const mins = Number(tds[2].textContent);
    const attempts = Number(tds[3].querySelector("input").value||0);
    const success = Number(tds[4].querySelector("input").value||0);
    const points = Number(tds[5].textContent||0);
    details.push({cat,name,mins,attempts,success,points});
    total += points;
  });
  const rec = { id: sessionId, when: new Date().toISOString(), focus, total, details };
  const key = "golf-practice-history";
  const arr = JSON.parse(localStorage.getItem(key)||"[]");
  arr.unshift(rec);
  localStorage.setItem(key, JSON.stringify(arr));
  return rec;
}
function refreshHistory(){
  const key = "golf-practice-history";
  const arr = JSON.parse(localStorage.getItem(key)||"[]");
  const tbody = document.querySelector("#historyTable tbody");
  if (!tbody) return;
  tbody.innerHTML = "";
  arr.forEach(rec => {
    const date = new Date(rec.when);
    const dstr = date.toLocaleString();
    const tr = document.createElement("tr");
    const btn = document.createElement("button");
    btn.textContent = "View";
    btn.className = "btn flat";
    btn.onclick = function(){ alert(JSON.stringify(rec.details, null, 2)); };
    const tdBtn = document.createElement("td"); tdBtn.appendChild(btn);
    tr.innerHTML = `<td>${dstr}</td><td>${rec.id}</td><td>${rec.focus}</td><td>${rec.total}</td>`;
    tr.appendChild(tdBtn);
    tbody.appendChild(tr);
  });
}

// Bootstrap minimal UI
(function bootstrap(){
  currentSessionId = newSessionId();
  document.getElementById("sessionIdPill").textContent = "Session " + currentSessionId;
  renderScoring({Range:[], "Short Game":[], Putting:[]}, currentSessionId);
  refreshHistory();
})();
</script>
</body>
</html>
